# çŸ­é“¾æ¥æœåŠ¡ (Short URL Service)

ä¸€ä¸ªé«˜æ€§èƒ½ã€åˆ†å¸ƒå¼çš„çŸ­é“¾æ¥ç”ŸæˆæœåŠ¡ï¼Œé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯ï¼Œæä¾›åˆ›å»ºçŸ­é“¾æ¥ï¼Œé‡å®šå‘çŸ­é“¾æ¥æ¥å£ã€‚


## ğŸš€ æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯ |
|------|------|
| **è¯­è¨€** | Go 1.24+ |
| **Webæ¡†æ¶** | Gin + gRPC |
| **æ•°æ®å­˜å‚¨** | MySQL 8.0 + Redis |
| **æœåŠ¡å‘ç°** | etcd |
| **é™æµç†”æ–­** | ä»¤ç‰Œæ¡¶ + Hystrix |
| **å®¹å™¨åŒ–** | Docker + Docker Compose |
| **åå‘ä»£ç†** | Nginx |
| **æ—¥å¿—ç›‘æ§** | Zap + å¥åº·æ£€æŸ¥ |


## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### 1. é˜²ç©¿é€æ¶æ„
**æ ¡éªŒç  + åˆ†å¸ƒå¼å½’æ¡£å¸ƒéš†è¿‡æ»¤å™¨**
- æ— æ•ˆçŸ­é“¾æ¥è¯·æ±‚è¿‡æ»¤ï¼Œå½»åº•è§£å†³ç¼“å­˜ç©¿é€
- å¸ƒéš†è¿‡æ»¤å™¨æ”¯æŒå¢é‡æ›´æ–°æ— é”æœºåˆ¶ï¼ˆatomicåŸå­æ“ä½œï¼‰
- å¼‚æ­¥å½’æ¡£æœºåˆ¶ï¼Œä½æ€§èƒ½æŸè€—

### 2. æ°´å¹³åˆ†è¡¨å­˜å‚¨
- **6ä½çŸ­ç **æ”¯æŒ568äº¿æ¡è®°å½•å­˜å‚¨
- åˆ†è¡¨ç­–ç•¥é˜²æ­¢å•è¡¨æ•°æ®é‡è¿‡å¤§
- ç´¢å¼•ä¼˜åŒ–ä¿è¯æŸ¥è¯¢æ€§èƒ½

### 3. ä¸‰çº§å†™å…¥ä½“ç³»
**ç¯å½¢ç¼“å†²åŒº + å¯¹è±¡æ±  + å¹¶å‘å†™å…¥**
- èšåˆå•è¡Œæ’å…¥ä¸ºæ‰¹é‡äº‹åŠ¡å†™å…¥
- å†…å­˜ç¯å½¢ç¼“å†²åŒºåº”å¯¹çªå‘æµé‡
- å¯¹è±¡æ± å‡è½»GCå‹åŠ›ï¼Œåˆ†ç‰‡å¹¶è¡Œä¿è¯åŸå­æ€§

### 4. äº”çº§è¯»å–ä½“ç³»
**è¯·æ±‚åˆå¹¶ + è¯·æ±‚è¿‡æ»¤ + LocalCache + Redis + MySQL**
- Singleflightåˆå¹¶ç›¸åŒè¯·æ±‚ï¼Œè§£å†³ç¼“å­˜å‡»ç©¿
- TTLç»„åˆç­–ç•¥é˜²æ­¢ç¼“å­˜é›ªå´©
- å¤šçº§ç¼“å­˜é€çº§é™çº§ï¼Œä¿éšœé«˜å¯ç”¨

### 5. ä¸‰çº§é™æµä½“ç³»
**Nginx IPçº§ + åˆ†å¸ƒå¼é™æµå™¨ + Hystrix APIçº§**
- ç»†ç²’åº¦é™æµä¿æŠ¤ï¼Œå…œåº•æœåŠ¡å™¨æ€§èƒ½
- ä»¤ç‰Œæ¡¶ç®—æ³• + Redis Luaè„šæœ¬å®ç°
- è‡ªé€‚åº”ç†”æ–­æœºåˆ¶ï¼ˆé”™è¯¯ç‡é˜ˆå€¼ + æ£€æµ‹æ—¶é—´çª—å£ï¼‰

### 6. æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **å®šæ—¶æ¸…ç†**: Cronæ‰§è¡Œè¿‡æœŸæ•°æ®æ¸…ç†ï¼ˆç¼“å­˜+æ•°æ®åº“åŒå†™ï¼‰
- **å¸ƒéš†ç»´æŠ¤**: å¼‚æ­¥å½’æ¡£è¿‡æ»¤å™¨ï¼Œæ”¯æŒå¢é‡æ›´æ–°
- **ä¸€è‡´æ€§**: ç¼“å­˜æ•°æ®åº“æœ€ç»ˆä¸€è‡´æ€§ä¿è¯

### 7. å¾®æœåŠ¡æ¶æ„
**Docker + k8s å®¹å™¨åŒ–éƒ¨ç½²**
- nginxï¼ˆè´Ÿè½½å‡è¡¡ + åå‘ä»£ç†ï¼‰
- webï¼ˆç†”æ–­é™çº§ + é™æµï¼‰
- etcdï¼ˆæœåŠ¡æ³¨å†Œ + è´Ÿè½½å‡è¡¡ï¼‰
- rpcï¼ˆå¿ƒè·³æ£€æµ‹ + æœåŠ¡å‘ç°ï¼‰

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

```
short_url/
â”œâ”€â”€ rpc/                    # gRPCæœåŠ¡ç«¯
â”‚   â”œâ”€â”€ main.go            # RPCæœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ app.go             # RPCåº”ç”¨åˆå§‹åŒ–
â”‚   â”œâ”€â”€ wire.go            # ä¾èµ–æ³¨å…¥é…ç½®
â”‚   â”œâ”€â”€ wire_gen.go        # è‡ªåŠ¨ç”Ÿæˆçš„ä¾èµ–æ³¨å…¥ä»£ç 
â”‚   â”œâ”€â”€ grpc/              # gRPCå®ç°
â”‚   â”‚   â””â”€â”€ shortUrl.go    # gRPCæœåŠ¡å®ç°
â”‚   â”œâ”€â”€ service/           # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ shortUrl.go    # çŸ­é“¾æ¥æœåŠ¡
â”‚   â”‚   â””â”€â”€ type.go        # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ repository/        # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ shortUrl.go    # æ•°æ®è®¿é—®æ¥å£
â”‚   â”‚   â”œâ”€â”€ dao/           # æ•°æ®è®¿é—®å¯¹è±¡
â”‚   â”‚   â”‚   â”œâ”€â”€ init.go    # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”‚   â”‚   â”œâ”€â”€ shortUrl.go # çŸ­é“¾æ¥DAO
â”‚   â”‚   â”‚   â””â”€â”€ type.go    # DAOç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ cache/         # ç¼“å­˜å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ bloomFilterManager.go # å¸ƒéš†è¿‡æ»¤å™¨ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ shortUrl.go # çŸ­é“¾æ¥ç¼“å­˜
â”‚   â”‚   â”‚   â””â”€â”€ type.go    # ç¼“å­˜ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ type.go        # æ•°æ®ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ job/               # å®šæ—¶ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ cleaner.go     # æ¸…ç†ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ cronJob.go     # å®šæ—¶ä»»åŠ¡é…ç½®
â”‚   â”‚   â””â”€â”€ type.go        # ä»»åŠ¡ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ config/            # RPCé…ç½®
â”‚   â”‚   â””â”€â”€ config.template.yaml
â”‚   â””â”€â”€ ioc/               # ä¾èµ–æ³¨å…¥åˆå§‹åŒ–
â”‚       â”œâ”€â”€ db.go          # æ•°æ®åº“åˆå§‹åŒ–
â”‚       â”œâ”€â”€ etcd.go        # etcdå®¢æˆ·ç«¯åˆå§‹åŒ–
â”‚       â”œâ”€â”€ grpc.go        # gRPCæœåŠ¡åˆå§‹åŒ–
â”‚       â”œâ”€â”€ job.go         # å®šæ—¶ä»»åŠ¡åˆå§‹åŒ–
â”‚       â”œâ”€â”€ logger.go      # æ—¥å¿—åˆå§‹åŒ–
â”‚       â”œâ”€â”€ redis.go       # Rediså®¢æˆ·ç«¯åˆå§‹åŒ–
â”‚       â”œâ”€â”€ redisCache.go  # ç¼“å­˜åˆå§‹åŒ–
â”‚       â””â”€â”€ repo.go        # ä»“åº“åˆå§‹åŒ–
â”œâ”€â”€ web/                   # WebæœåŠ¡å±‚
â”‚   â”œâ”€â”€ main.go           # WebæœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ wire.go           # ä¾èµ–æ³¨å…¥é…ç½®
â”‚   â”œâ”€â”€ wire_gen.go       # è‡ªåŠ¨ç”Ÿæˆçš„ä¾èµ–æ³¨å…¥ä»£ç 
â”‚   â”œâ”€â”€ config/           # Webé…ç½®
â”‚   â”‚   â””â”€â”€ config.template.yaml
â”‚   â”œâ”€â”€ routes/           # HTTPè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ api.go        # APIè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ health.go     # å¥åº·æ£€æŸ¥è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ server.go     # æœåŠ¡è·¯ç”±
â”‚   â”‚   â””â”€â”€ type.go       # è·¯ç”±ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ middlewares/      # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ logger.go     # æ—¥å¿—ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ ratelimit.go  # é™æµä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ signature.go  # ç­¾åéªŒè¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ ioc/              # ä¾èµ–æ³¨å…¥åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ etcd.go       # etcdå®¢æˆ·ç«¯åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ hystrix.go    # ç†”æ–­å™¨åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ logger.go     # æ—¥å¿—åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ ratelimit.go  # é™æµå™¨åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ redis.go      # Rediså®¢æˆ·ç«¯åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ server.go     # æœåŠ¡åˆå§‹åŒ–
â”‚   â”‚   â”œâ”€â”€ shortUrl.go   # çŸ­é“¾æ¥æœåŠ¡åˆå§‹åŒ–
â”‚   â”‚   â””â”€â”€ web.go        # WebæœåŠ¡åˆå§‹åŒ–
â”‚   â”œâ”€â”€ pkg/              # Webå…¬å…±åº“
â”‚   â”‚   â””â”€â”€ ratelimiter.go
â”‚   â””â”€â”€ static/          # å‰ç«¯é™æ€èµ„æº
â”‚       â”œâ”€â”€ index.html
â”‚       â””â”€â”€ maintenance.html
â”œâ”€â”€ pkg/                  # å…¬å…±åº“
â”‚   â”œâ”€â”€ bloom/           # å¸ƒéš†è¿‡æ»¤å™¨
â”‚   â”‚   â”œâ”€â”€ bloom.go     # å¸ƒéš†è¿‡æ»¤å™¨å®ç°
â”‚   â”‚   â”œâ”€â”€ encryptor.go # åŠ å¯†å™¨
â”‚   â”‚   â”œâ”€â”€ lua.go       # Luaè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ redis_client.go # Rediså®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ scripts/     # Luaè„šæœ¬æ–‡ä»¶
â”‚   â”‚       â”œâ”€â”€ bloom_get.lua
â”‚   â”‚       â””â”€â”€ bloom_set.lua
â”‚   â”œâ”€â”€ generator/       # çŸ­é“¾æ¥ç”Ÿæˆå™¨
â”‚   â”‚   â”œâ”€â”€ charset.go   # å­—ç¬¦é›†å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ generator.go # ç”Ÿæˆå™¨å®ç°
â”‚   â”‚   â””â”€â”€ generator_test.go # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ go-redis-tokenbuket/ # Redisä»¤ç‰Œæ¡¶é™æµ
â”‚   â”‚   â”œâ”€â”€ ratelimit.go # é™æµå®ç°
â”‚   â”‚   â””â”€â”€ scripts/     # Luaè„šæœ¬
â”‚   â”‚       â””â”€â”€ token_bucket.lua
â”‚   â”œâ”€â”€ logfile/         # æ—¥å¿—æ–‡ä»¶å¤„ç†
â”‚   â”‚   â””â”€â”€ logfile.go
â”‚   â”œâ”€â”€ sharding/        # åˆ†ç‰‡ç­–ç•¥
â”‚   â”‚   â””â”€â”€ firstCharSharding.go # é¦–å­—ç¬¦åˆ†ç‰‡
â”‚   â””â”€â”€ sign/            # ç­¾åéªŒè¯
â”‚       â”œâ”€â”€ epay/        # æ”¯ä»˜ç›¸å…³ç­¾å
â”‚       â”‚   â”œâ”€â”€ epay.go
â”‚       â”‚   â””â”€â”€ epay_test.go
â”‚       â””â”€â”€ type.go      # ç­¾åç±»å‹å®šä¹‰
â”œâ”€â”€ proto/               # Protocol Bufferså®šä¹‰
â”‚   â”œâ”€â”€ short_url/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ short_url.pb.go
â”‚   â”‚       â””â”€â”€ short_url_grpc.pb.go
â”‚   â””â”€â”€ short_url.proto  # Protocol Bufferså®šä¹‰
â”œâ”€â”€ scripts/             # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ etcd_data/       # etcdæ•°æ®è„šæœ¬
â”‚   â””â”€â”€ mysql/
â”‚       â”œâ”€â”€ export_short_urls.go # æ•°æ®å¯¼å‡ºå·¥å…·
â”‚       â””â”€â”€ init.sql     # MySQLåˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ nginx/               # Nginxé…ç½®
â”‚   â””â”€â”€ nginx.conf       # Nginxé…ç½®æ–‡ä»¶
â”œâ”€â”€ test/                # æµ‹è¯•æ–‡ä»¶
â”‚   â””â”€â”€ mem_test.go      # å†…å­˜æµ‹è¯•
â”œâ”€â”€ go.mod               # Goæ¨¡å—æ–‡ä»¶
â”œâ”€â”€ go.sum               # Goä¾èµ–æ ¡éªŒæ–‡ä»¶
â”œâ”€â”€ docker-compose.yaml  # å®¹å™¨ç¼–æ’
â””â”€â”€ .gitignore          # Gitå¿½ç•¥æ–‡ä»¶
```

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Go 1.24+
- Docker & Docker Compose

### 1. å¯åŠ¨ä¾èµ–æœåŠ¡
```bash
docker-compose up 
```

### 3. å¯åŠ¨RPCæœåŠ¡
```bash
cd rpc/
go run main.go --config config/config.template.yaml
```

### 4. å¯åŠ¨WebæœåŠ¡
```bash
cd web/
go run main.go --config config/config.template.yaml
```

### 5. è®¿é—®æœåŠ¡
- Webç•Œé¢: http://localhost:8080
- APIæ¥å£: http://localhost:8080/api/shorten
- å¥åº·æ£€æŸ¥: http://localhost:8080/health
- ginxä»£ç†: http://localhost:8888/
### 6. æµ‹è¯•
//test1:
@"                                                                     

>> wrk.method = "POST"                             
>> wrk.headers["Content-Type"] = "application/json"
>>
>> -- åˆå§‹åŒ–éšæœºç§å­ï¼ˆç¡®ä¿æ¯æ¬¡è¿è¡Œç”Ÿæˆä¸åŒéšæœºå€¼ï¼‰
>> function init(args)
>>     math.randomseed(os.time() * 1000 + math.random(1, 1000))
>> end
>>
>> function randomString(length, charset)
>>     local res = ""
>>     for i = 1, length do
>>         local rand = math.random(#charset)
>>         res = res .. string.sub(charset, rand, rand)
>>     end
>>     return res
>> end
>>
>> function request()
>>     local charset = "abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ+="
>>     local randomStr = randomString(200, charset)
>>     local body = string.format('{"origin_url": "%s"}', randomStr)
>>     return wrk.format(nil, nil, nil, body)
>> end
>> "@ | Out-File -FilePath create.lua -Encoding utf8


docker run --rm -v ${PWD}:/scripts williamyeh/wrk `
>>   -c 50 -d 10s -t 4 -s /scripts/create.lua `
>>   http://host.docker.internal:8080/api/create
